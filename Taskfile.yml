# https://taskfile.dev

version: '3'

silent: true

vars:
  ARTIFACT_REPO_FILES: https://raw.githubusercontent.com/bth-algo/template/refs/heads/main/
  ARTIFACT_TMP_FILES: /tmp/tmp-artifacts
  ARTIFACT_REPO: https://github.com/bth-algo/template

tasks:

  create-src-dirs:
    desc: "Creates the src directory structure if they do not exist"
    cmds:
      - mkdir -p src/kmom01/{convert,lab_01,practice,split_bill} src/kmom02/{marvin1,practice,practice_validation} src/kmom03/{marvin2,practice,practice_validation} src/kmom04/{marvin3,practice,practice_validation,lab_04} src/kmom05/{emissions,practice,practice_validation}
      - echo "Source directories created successfully. PS empty directories are not shown with 'git status'."
      - tree -d src

  download-artifacts:
    desc: "Downloads the artifacts repo to /tmp/tmp-artifacts"
    internal: true
    cmds:
      - task: clear-artifacts
      - git clone --quiet {{.ARTIFACT_REPO}}.git {{.ARTIFACT_TMP_FILES}}



  clear-artifacts:
    desc: "Removes /tmp/tmp-artifacts, used to clear the artifacts repo"
    internal: true
    cmds:
      - rm -rf {{.ARTIFACT_TMP_FILES}}



  download-tests:
    desc: "Replaces files in tests/ with files from the artifact repository, {{.ARTIFACT_REPO}}"
    cmds:
      - task: download-artifacts
      - cp -a {{.ARTIFACT_TMP_FILES}}/tests/. tests
      - task: clear-artifacts
      - echo "Tests downloaded successfully."



  download-ruff-config:
    desc: "Downloads the ruff configuration file from the artifact repository"
    cmds:
      - curl -s -L -o ruff.toml {{.ARTIFACT_REPO_FILES}}/ruff.toml
      - echo "Ruff configuration downloaded successfully."



  download-taskfile:
    desc: "Downloads the Taskfile from the artifact repository"
    cmds:
      - curl -s -L -o Taskfile.yml {{.ARTIFACT_REPO_FILES}}/Taskfile.yml
      - echo "Taskfile downloaded successfully."



  download-lab:
    desc: "Download a lab. Run with 'uv run task download-lab -- lab_XX', replace XX with the lab number."
    dir: "{{.USER_WORKING_DIR}}"
    preconditions:
      - sh: '[[ "$PWD" == */{{.CLI_ARGS}} ]]'
        msg: "You must stand in a directory called 'lab_XX' to run this task. EX. 'lab_01'."
    prompt: "This will overwrite 'answer.py' if you already have it downloaded. If you have started on the lab and want to save your work, rename your 'answer.py' to something else before continuing.\n Do you want to continue?"
    vars:
      LAB_PATH:
        sh: echo "$PWD" | awk -F'/src/' '{print $2}'
    cmds:
      - task: download-artifacts
      - cp -a {{.ARTIFACT_TMP_FILES}}/src/{{.LAB_PATH}}/. .
      - task: clear-artifacts
      - echo "{{.CLI_ARGS}} downloaded successfully. You can use the command 'ls' to se what files have been downloaded."



  download-workflow:
    desc: "Download workflows file that checks code at pull request."
    cmds:
      - mkdir -p .github/workflows
      - curl -s -L -o .github/workflows/main.yml {{.ARTIFACT_REPO_FILES}}/.github/workflows/main.yml
      - echo "Workflow file downloaded successfully."


  download-extensions:
    desc: "Download file with recommended extensions."
    cmds:
      - mkdir -p .vscode
      - curl -s -L -o .vscode/extensions.json {{.ARTIFACT_REPO_FILES}}/.vscode/extensions.json
      - curl -s -L -o .vscode/settings.json {{.ARTIFACT_REPO_FILES}}/.vscode/settings.json
      - echo "Recommended extensions successfully."



  download-hooks:
    desc: "Download git hook files from the template repository and install them"
    vars:
      TEMPLATE_REPO: https://github.com/bth-algo/template
    cmds:
      - task: download-artifacts
        vars:
          ARTIFACT_REPO: "{{.TEMPLATE_REPO}}"
      - mkdir -p hooks
      - mkdir -p .git/hooks
      - cp -a {{.ARTIFACT_TMP_FILES}}/hooks/. hooks/
      - cp -a {{.ARTIFACT_TMP_FILES}}/hooks/. .git/hooks/
      - chmod +x .git/hooks/*
      - task: clear-artifacts
      - echo "Git hooks downloaded and installed successfully."



  download-hooks:
    desc: "Download git hook files from the template repository and install them"
    cmds:
      - task: download-artifacts
      - mkdir -p hooks
      - mkdir -p .git/hooks
      - cp -a {{.ARTIFACT_TMP_FILES}}/hooks/. hooks/
      - cp -a {{.ARTIFACT_TMP_FILES}}/hooks/. .git/hooks/
      - chmod +x .git/hooks/*
      - task: clear-artifacts
      - echo "Git hooks downloaded and installed successfully."



  check-have-files:
    desc: "Checks that repo contain all needed files."
    cmds:
      - | 
        [ -f .gitignore ] && echo "âœ… .gitignore file found!" || { echo "âŒ Error: .gitignore file not found!"; exit 1; }
        [ -f .github/workflows/main.yml ] && echo "âœ… .github/workflows/main.yml file found!" || { echo "âŒ Error: .github/workflows/main.yml file not found!"; exit 1; }
        [ -f .git/hooks/pre-push ] && echo "âœ… .git/hooks/pre-push file found!" || { echo "âŒ Error: .git/hooks/pre-push file not found!"; exit 1; }
        [ -d tests ] && echo "âœ… tests directory found!" || { echo "âŒ Error: tests directory not found!"; exit 1; }
        [ -f .editorconfig ] && echo "âœ… .editorconfig file found!" || { echo "âŒ Error: .editorconfig file not found!"; exit 1; }
        [ -f .python-version ] && echo "âœ… .python-version file found!" || { echo "âŒ Error: .python-version file not found!"; exit 1; }
        [ -f pyproject.toml ] && echo "âœ… pyproject.toml file found!" || { echo "âŒ Error: pyproject.toml file not found!"; exit 1; }
        [ -f ruff.toml ] && echo "âœ… ruff.toml file found!" || { echo "âŒ Error: ruff.toml file not found!"; exit 1; }
        [ -f uv.lock ] && echo "âœ… uv.lock file found!" || { echo "âŒ Error: uv.lock file not found!"; exit 1; }



  # ==========================================
  # Submission Commands
  # ==========================================

  check-ready:
    desc: "Check if assignment is ready for submission. Usage: 'task check-ready -- kmom01'"
    cmds:
      - |
        # â”€â”€ Validate argument â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if [ -z "{{.CLI_ARGS}}" ]; then
          echo "âŒ No assignment specified."
          echo ""
          echo "  Usage:   task check-ready -- <kmom>"
          echo "  Example: task check-ready -- kmom01"
          echo ""
          echo "  Valid assignments: kmom01 â€¦ kmom10"
          exit 1
        fi

        KMOM="{{.CLI_ARGS}}"

        if ! echo "$KMOM" | grep -qE '^kmom(0[1-9]|10)$'; then
          echo "âŒ Invalid assignment name: '$KMOM'"
          echo ""
          echo "  Expected format: kmom01 â€¦ kmom10"
          exit 1
        fi

        KMOM_NUM=$(echo "$KMOM" | sed 's/kmom//')
        ERRORS=0

        echo "ğŸ” Checking readiness for $KMOM..."
        echo ""

        # â”€â”€ Check: running from repo root â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        GIT_ROOT=$(git rev-parse --show-toplevel 2>/dev/null)
        if [ -z "$GIT_ROOT" ]; then
          echo "âŒ Not inside a git repository."
          echo "   Navigate to your repository root and try again."
          exit 1
        fi
        if [ "$PWD" != "$GIT_ROOT" ]; then
          echo "âŒ You must run this command from the repository root."
          echo "   Current directory : $PWD"
          echo "   Repository root   : $GIT_ROOT"
          echo "   Fix: cd \"$GIT_ROOT\""
          exit 1
        fi
        echo "âœ… Running from repository root."

        # â”€â”€ Check: no uncommitted changes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if [ -n "$(git status --porcelain)" ]; then
          echo "âŒ You have uncommitted changes:"
          git status --short
          echo ""
          echo "   Commit all changes before submitting:"
          echo "   git add -A && git commit -m 'done with $KMOM'"
          ERRORS=$((ERRORS + 1))
        else
          echo "âœ… No uncommitted changes."
        fi

        # â”€â”€ Check: submission tag v.YX.Z exists â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        TAG=$(git tag --list "v.${KMOM_NUM}.*" | sort -V | tail -1)
        if [ -z "$TAG" ]; then
          echo "âŒ No submission tag found matching 'v.${KMOM_NUM}.*'."
          echo ""
          echo "   Create and push a tag before submitting, e.g.:"
          echo "   git tag v.${KMOM_NUM}.0"
          echo "   git push origin v.${KMOM_NUM}.0"
          ERRORS=$((ERRORS + 1))
        else
          echo "âœ… Submission tag found: $TAG"
        fi

        # â”€â”€ Ruff â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        echo ""
        echo "Running Ruff on src/$KMOM/ ..."
        if uv run ruff check src/$KMOM/; then
          echo "âœ… Ruff: no issues."
        else
          echo ""
          echo "âŒ Ruff found code style issues in src/$KMOM/."
          echo "   Rule reference       : https://docs.astral.sh/ruff/rules/"
          ERRORS=$((ERRORS + 1))
        fi

        # â”€â”€ Tests â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        echo ""
        echo "Running tests for $KMOM ..."
        if uv run tester tests/$KMOM/; then
          echo "âœ… All tests passed."
        else
          echo ""
          echo "âŒ One or more tests failed for $KMOM."
          ERRORS=$((ERRORS + 1))
        fi

        # â”€â”€ Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        echo ""
        if [ "$ERRORS" -eq 0 ]; then
          echo "ğŸ‰ $KMOM is ready for submission!"
        else
          echo "ğŸš« $KMOM is NOT ready â€” $ERRORS check(s) failed. Fix the issues above and run again."
          exit 1
        fi



  setup:
    desc: "Initial setup - run all configuration downloads"
    cmds:
      - echo "Running initial setup..."
      - task: create-src-dirs
      - task: download-tests
      - task: download-ruff-config
      - task: download-workflow
      - task: download-extensions
      - task: download-hooks
      - task: download-hooks
      - task: check-have-files
      - echo ""
      - echo "âœ… Setup complete!"
      - echo ""
      - echo 'Next steps{{":"}}'
      - echo '  1. Start your first assignment{{":"}} task start-kmom -- kmom01'
      - echo '  2. Implement your code in src/kmom01/'
      - echo '  3. Run tests{{":"}} task test -- kmom01'
