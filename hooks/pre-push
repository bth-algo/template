#!/bin/bash
#
# Git pre-push hook to validate kmom code before pushing tags
#
# This hook validates tags with format vXX.Y or vXX.Y.Z where XX is the kmom number.
# It runs tests and linting for the corresponding kmom and blocks the push if validation fails.
#
# To install: This hook is automatically installed by 'task setup' or can be updated with 'task update-hooks'

# Read stdin to get information about what's being pushed
while read local_ref local_sha remote_ref remote_sha; do
  # Check if this is a tag push
  if [[ "$remote_ref" =~ refs/tags/ ]]; then
    # Extract the tag name
    tag_name="${remote_ref#refs/tags/}"
    
    # Validate tag format: vXX.Y or vXX.Y.Z
    if [[ "$tag_name" =~ ^v([0-9]{2})\.([0-9]+)(\.([0-9]+))?$ ]]; then
      kmom_num="${BASH_REMATCH[1]}"
      minor="${BASH_REMATCH[2]}"
      patch="${BASH_REMATCH[4]}"
      
      kmom="kmom${kmom_num}"
      
      echo "=================================================="
      echo "Validating tag: $tag_name (kmom: $kmom)"
      echo "=================================================="
      echo ""
      
      # Check if tests directory exists
      if [ ! -d "tests/$kmom" ]; then
        echo "❌ Error: tests/$kmom directory not found!"
        echo "   Cannot validate tag $tag_name"
        exit 1
      fi
      
      # Run tests
      echo "Running tests for $kmom..."
      if ! uv run tester tests/$kmom/; then
        echo ""
        echo "❌ Tests failed for $kmom"
        echo "   Fix the failing tests before pushing tag $tag_name"
        exit 1
      fi
      echo "✅ All tests passed"
      echo ""
      
      # Run ruff check
      echo "Running Ruff linting for $kmom..."
      if ! uv run ruff check src/$kmom/; then
        echo ""
        echo "❌ Ruff linting failed for $kmom"
        echo "   Fix the linting issues before pushing tag $tag_name"
        exit 1
      fi
      echo "✅ Ruff checks passed"
      echo ""
      
      echo "=================================================="
      echo "✅ Validation successful for $tag_name"
      echo "=================================================="
      echo ""
      
    else
      echo "⚠️  Warning: Tag '$tag_name' does not match expected format vXX.Y or vXX.Y.Z"
      echo "   Expected format: v01.0, v02.1, v03.0.1, etc."
      echo "   Skipping validation for this tag."
    fi
  fi
done

# If we reach here, all validations passed (or no tags were pushed)
exit 0
